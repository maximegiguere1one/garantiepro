<!DOCTYPE html>
<html>
<head>
  <title>Test 1: Acc√®s Page Organisations</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
    .test { border: 2px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
    .pass { border-color: #22c55e; background: #f0fdf4; }
    .fail { border-color: #ef4444; background: #fef2f2; }
    .pending { border-color: #f59e0b; background: #fffbeb; }
    h1 { color: #1e293b; }
    h2 { color: #475569; font-size: 18px; }
    pre { background: #f8fafc; padding: 10px; border-radius: 4px; overflow-x: auto; }
    .status { font-weight: bold; }
  </style>
</head>
<body>
  <h1>üß™ TEST 1: Acc√®s √† la Page "G√©rer les franchis√©s"</h1>
  <div id="results"></div>
  
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.57.4';
    
    const supabase = createClient(
      'https://wppvbdbpfnkbrlpxkcgb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwcHZiZGJwZm5rYnJscHhrY2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc5ODI3OTcsImV4cCI6MjA0MzU1ODc5N30.DlII4cM7ahrUXwlj-n1QRWQrwB-J63mcFmJJAyK6MMc'
    );
    
    const results = document.getElementById('results');
    
    function addTest(title, status, details) {
      const div = document.createElement('div');
      div.className = `test ${status}`;
      div.innerHTML = `
        <h2>${title}</h2>
        <div class="status">${status === 'pass' ? '‚úÖ PASS' : status === 'fail' ? '‚ùå FAIL' : '‚è≥ PENDING'}</div>
        <pre>${details}</pre>
      `;
      results.appendChild(div);
    }
    
    async function runTests() {
      // Test 1.1: V√©rifier l'authentification
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error || !user) {
          addTest('1.1: Authentification', 'fail', 'Utilisateur non connect√©');
          return;
        }
        addTest('1.1: Authentification', 'pass', `Email: ${user.email}\nID: ${user.id}`);
        
        // Test 1.2: V√©rifier le profil et le r√¥le
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('id, email, role, organization_id, organizations(id, name, type)')
          .eq('id', user.id)
          .single();
        
        if (profileError) {
          addTest('1.2: Profil utilisateur', 'fail', `Erreur: ${profileError.message}`);
          return;
        }
        
        const isMasterOrAdmin = ['master', 'admin'].includes(profile.role);
        addTest('1.2: Profil utilisateur', isMasterOrAdmin ? 'pass' : 'fail', 
          `R√¥le: ${profile.role}\n` +
          `Organisation: ${profile.organizations?.name}\n` +
          `Type org: ${profile.organizations?.type}\n` +
          `Peut voir page: ${isMasterOrAdmin ? 'OUI' : 'NON'}`
        );
        
        // Test 1.3: V√©rifier isOwner status
        const isOwner = profile.role === 'master' || 
                       (profile.organizations?.type === 'owner' && profile.role === 'admin');
        
        addTest('1.3: Statut Owner (requis pour menu)', isOwner ? 'pass' : 'fail',
          `Role: ${profile.role}\n` +
          `Org type: ${profile.organizations?.type}\n` +
          `isOwner: ${isOwner}\n` +
          `Menu visible: ${isOwner ? 'OUI' : 'NON'}`
        );
        
        // Test 1.4: V√©rifier l'acc√®s √† la table organizations
        const { data: orgs, error: orgsError } = await supabase
          .from('organizations')
          .select('id, name, type, status')
          .limit(1);
        
        if (orgsError) {
          addTest('1.4: Acc√®s liste organisations', 'fail', `Erreur RLS: ${orgsError.message}`);
        } else {
          addTest('1.4: Acc√®s liste organisations', 'pass', 
            `Organisations accessibles: ${orgs?.length || 0}\n` +
            `Premi√®re org: ${orgs?.[0]?.name || 'Aucune'}`
          );
        }
        
      } catch (error) {
        addTest('Erreur g√©n√©rale', 'fail', error.message);
      }
    }
    
    runTests();
  </script>
</body>
</html>
