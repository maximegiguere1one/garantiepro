<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Connexion - Garantie Pro Remorque</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
      padding: 50px;
      max-width: 700px;
      width: 100%;
      text-align: center;
    }
    h1 {
      color: #1e293b;
      font-size: 32px;
      margin-bottom: 15px;
      font-weight: 800;
    }
    .subtitle {
      color: #64748b;
      font-size: 16px;
      margin-bottom: 30px;
    }
    .status-grid {
      display: grid;
      gap: 15px;
      margin: 30px 0;
    }
    .status-item {
      padding: 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 15px;
      font-weight: 600;
    }
    .status-item.good {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    .status-item.bad {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #dc2626;
    }
    .icon { font-size: 24px; margin-right: 10px; }
    button {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: white;
      border: none;
      padding: 18px 40px;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
      text-transform: uppercase;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.5);
    }
    .alert {
      background: #fef3c7;
      color: #92400e;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 4px solid #f59e0b;
      text-align: left;
      line-height: 1.8;
    }
    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 25px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: 600;
      border: 2px solid #10b981;
      animation: slideIn 0.5s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Fix Connexion Compl√®te</h1>
    <div class="subtitle">R√©pare tous les probl√®mes de cache et de session</div>

    <div class="status-grid" id="statusGrid">
      <div class="status-item bad">
        <span><span class="icon">‚è≥</span> V√©rification...</span>
      </div>
    </div>

    <div class="alert">
      <strong>‚ö†Ô∏è Probl√®me de Connexion</strong>
      Tu ne peux pas te connecter parce que :
      <ul style="margin-top: 10px; margin-left: 20px;">
        <li><strong>Mode Emergency activ√©</strong> dans localStorage</li>
        <li><strong>Session Supabase cached</strong> corrompue</li>
        <li><strong>Cache navigateur</strong> avec ancienne version</li>
      </ul>
    </div>

    <button onclick="fixEverything()">üöÄ TOUT R√âPARER</button>

    <div id="result"></div>
  </div>

  <script>
    function checkStatus() {
      const statusGrid = document.getElementById('statusGrid');
      statusGrid.innerHTML = '';

      const emergencyMode = localStorage.getItem('emergency_mode_enabled');
      const emergencyClass = emergencyMode === 'true' ? 'bad' : 'good';
      const emergencyIcon = emergencyMode === 'true' ? '‚ùå' : '‚úÖ';
      const emergencyText = emergencyMode === 'true' ? 'Mode Emergency ACTIF' : 'Mode Emergency OK';

      statusGrid.innerHTML += `<div class="status-item ${emergencyClass}"><span><span class="icon">${emergencyIcon}</span> ${emergencyText}</span></div>`;

      const authToken = localStorage.getItem('supabase.auth.token');
      const authClass = authToken ? 'bad' : 'good';
      const authIcon = authToken ? 'üîê' : '‚úÖ';
      const authText = authToken ? 'Session cached (doit √™tre cleared)' : 'Pas de session cached';

      statusGrid.innerHTML += `<div class="status-item ${authClass}"><span><span class="icon">${authIcon}</span> ${authText}</span></div>`;
    }

    async function fixEverything() {
      const resultDiv = document.getElementById('result');

      localStorage.removeItem('emergency_mode_enabled');
      localStorage.removeItem('emergency_profile');
      localStorage.clear();
      sessionStorage.clear();

      document.cookie.split(";").forEach(c => {
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
      });

      if ('caches' in window) {
        const names = await caches.keys();
        await Promise.all(names.map(name => caches.delete(name)));
      }

      resultDiv.innerHTML = `
        <div class="success-message">
          ‚úÖ TOUT EST R√âPAR√â !<br><br>
          <strong>Maintenant :</strong><br>
          1. Ctrl+Shift+R pour vider le cache<br>
          2. Ferme TOUS les onglets<br>
          3. Navigation priv√©e (Ctrl+Shift+N)<br>
          4. Va sur www.garantieproremorque.com<br>
          5. Login normalement<br><br>
          Redirection dans 3 secondes...
        </div>
      `;

      await checkStatus();

      setTimeout(() => {
        window.location.href = '/';
      }, 3000);
    }

    checkStatus();
  </script>
</body>
</html>
