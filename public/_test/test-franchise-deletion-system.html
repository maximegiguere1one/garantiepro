<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test SystÃ¨me de Suppression - Pro Remorque</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #dc2626;
      border-bottom: 3px solid #dc2626;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border-left: 4px solid #3b82f6;
      background: #f8fafc;
      border-radius: 4px;
    }
    .success {
      color: #10b981;
      font-weight: bold;
    }
    .error {
      color: #dc2626;
      font-weight: bold;
    }
    .warning {
      color: #f59e0b;
      font-weight: bold;
    }
    button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 10px 5px;
    }
    button:hover {
      background: #b91c1c;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .log {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .log-line {
      margin: 5px 0;
      padding: 3px 0;
    }
    .summary {
      background: #ecfdf5;
      border: 2px solid #10b981;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .summary.failed {
      background: #fef2f2;
      border-color: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Test SystÃ¨me de Suppression de Franchise</h1>
    <p><strong>Client:</strong> Stephane@proremorque.com</p>
    <p><strong>Date:</strong> 5 DÃ©cembre 2025</p>

    <div class="test-section">
      <h3>Instructions</h3>
      <p>Ce test vÃ©rifie que toutes les fonctions de suppression fonctionnent correctement.</p>
      <p>Cliquez sur "Lancer les Tests" pour vÃ©rifier l'Ã©tat du systÃ¨me.</p>
      <p><strong>Note:</strong> Aucune donnÃ©e ne sera supprimÃ©e - test en lecture seule.</p>
    </div>

    <button id="runTests" onclick="runAllTests()">ğŸš€ Lancer les Tests</button>
    <button id="clearLog" onclick="clearLog()">ğŸ—‘ï¸ Effacer le Log</button>

    <div id="summary"></div>
    <div class="log" id="testLog"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://fkxldrkkqvputdgfpayi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZreGxkcmtrcXZwdXRkZ2ZwYXlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjczNzUzMzEsImV4cCI6MjA0Mjk1MTMzMX0.gZPQueeBygwt7IJJL88Kxwyu8LNl7G_bR4xmYRnZPQo';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let testResults = {
      total: 0,
      passed: 0,
      failed: 0,
      warnings: 0
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('testLog');
      const line = document.createElement('div');
      line.className = 'log-line';

      const timestamp = new Date().toLocaleTimeString();
      let prefix = 'ğŸ“‹';
      let color = '#e2e8f0';

      if (type === 'success') {
        prefix = 'âœ“';
        color = '#10b981';
        testResults.passed++;
      } else if (type === 'error') {
        prefix = 'âœ—';
        color = '#dc2626';
        testResults.failed++;
      } else if (type === 'warning') {
        prefix = 'âš ';
        color = '#f59e0b';
        testResults.warnings++;
      }

      line.innerHTML = `<span style="color: #64748b">[${timestamp}]</span> <span style="color: ${color}">${prefix}</span> ${message}`;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('testLog').innerHTML = '';
      document.getElementById('summary').innerHTML = '';
      testResults = { total: 0, passed: 0, failed: 0, warnings: 0 };
    }

    function showSummary() {
      const summaryDiv = document.getElementById('summary');
      const allPassed = testResults.failed === 0;

      summaryDiv.className = allPassed ? 'summary' : 'summary failed';
      summaryDiv.innerHTML = `
        <h3>${allPassed ? 'âœ… Tous les tests sont rÃ©ussis!' : 'âŒ Certains tests ont Ã©chouÃ©'}</h3>
        <p><strong>Total:</strong> ${testResults.total} tests</p>
        <p><strong>RÃ©ussis:</strong> <span class="success">${testResults.passed}</span></p>
        <p><strong>Ã‰chouÃ©s:</strong> <span class="error">${testResults.failed}</span></p>
        <p><strong>Avertissements:</strong> <span class="warning">${testResults.warnings}</span></p>
        ${allPassed ? '<p><strong>ğŸ‰ Le systÃ¨me est prÃªt pour Stephane!</strong></p>' : '<p><strong>VÃ©rifier les erreurs ci-dessus</strong></p>'}
      `;
    }

    async function runAllTests() {
      clearLog();
      document.getElementById('runTests').disabled = true;

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      log('DÃ‰BUT DES TESTS - SYSTÃˆME DE SUPPRESSION', 'info');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

      try {
        // Test 1: VÃ©rifier la connexion Supabase
        testResults.total++;
        log('Test 1: Connexion Ã  Supabase...', 'info');
        const { data: testConnection, error: connError } = await supabase
          .from('organizations')
          .select('count')
          .limit(1)
          .single();

        if (connError) {
          log('Test 1 Ã‰CHOUÃ‰: ' + connError.message, 'error');
        } else {
          log('Test 1 RÃ‰USSI: Connexion Supabase OK', 'success');
        }

        // Test 2: Trouver une franchise de test
        testResults.total++;
        log('Test 2: Recherche de franchise de test...', 'info');
        const { data: testOrg, error: orgError } = await supabase
          .from('organizations')
          .select('id, name, is_master')
          .eq('is_master', false)
          .limit(1)
          .maybeSingle();

        if (orgError) {
          log('Test 2 Ã‰CHOUÃ‰: ' + orgError.message, 'error');
          return;
        }

        if (!testOrg) {
          log('Test 2 AVERTISSEMENT: Aucune franchise disponible pour test', 'warning');
          return;
        }

        log(`Test 2 RÃ‰USSI: Franchise trouvÃ©e: ${testOrg.name}`, 'success');

        // Test 3: Fonction get_franchise_deletion_stats
        testResults.total++;
        log('Test 3: Appel get_franchise_deletion_stats...', 'info');
        const { data: stats, error: statsError } = await supabase
          .rpc('get_franchise_deletion_stats', {
            p_franchise_id: testOrg.id
          });

        if (statsError) {
          log('Test 3 Ã‰CHOUÃ‰: ' + statsError.message, 'error');
          if (statsError.message.includes('fi.amount')) {
            log('  â†’ ERREUR CRITIQUE: Colonne fi.amount dÃ©tectÃ©e (devrait Ãªtre total_amount)', 'error');
          }
        } else {
          log('Test 3 RÃ‰USSI: Statistiques chargÃ©es', 'success');
          log(`  â†’ Garanties: ${stats.total_warranties}`, 'info');
          log(`  â†’ Clients: ${stats.total_customers}`, 'info');
          log(`  â†’ Factures impayÃ©es: ${stats.unpaid_invoices}`, 'info');
          log(`  â†’ Montant impayÃ©: ${stats.total_unpaid_amount} $`, 'info');
        }

        // Test 4: Fonction get_available_destination_franchises
        testResults.total++;
        log('Test 4: Appel get_available_destination_franchises...', 'info');
        const { data: available, error: availError } = await supabase
          .rpc('get_available_destination_franchises', {
            p_exclude_franchise_id: testOrg.id
          });

        if (availError) {
          log('Test 4 Ã‰CHOUÃ‰: ' + availError.message, 'error');
          if (availError.code === 'PGRST202') {
            log('  â†’ ERREUR CRITIQUE: ParamÃ¨tre p_exclude_franchise_id non trouvÃ©', 'error');
          }
        } else {
          log(`Test 4 RÃ‰USSI: ${available.length} franchise(s) disponible(s)`, 'success');
          if (available.length === 0) {
            log('  â†’ AVERTISSEMENT: Aucune autre franchise pour transfert', 'warning');
          } else {
            available.slice(0, 3).forEach(f => {
              log(`  â†’ ${f.franchise_name} (${f.total_warranties} garanties)`, 'info');
            });
          }
        }

        // Test 5: VÃ©rifier la table franchise_invoices
        testResults.total++;
        log('Test 5: VÃ©rification structure franchise_invoices...', 'info');
        const { data: invoiceTest, error: invoiceError } = await supabase
          .from('franchise_invoices')
          .select('total_amount, status')
          .limit(1)
          .maybeSingle();

        if (invoiceError && invoiceError.code === '42703') {
          log('Test 5 Ã‰CHOUÃ‰: Colonne total_amount manquante', 'error');
        } else {
          log('Test 5 RÃ‰USSI: Structure franchise_invoices correcte', 'success');
        }

        // Test 6: VÃ©rifier la fonction transfer_and_delete_franchise existe
        testResults.total++;
        log('Test 6: VÃ©rification fonction principale...', 'info');
        const { data: funcCheck, error: funcError } = await supabase
          .rpc('pg_get_function_identity_arguments', { funcid: 'transfer_and_delete_franchise' })
          .maybeSingle();

        // Note: Cette fonction pourrait ne pas exister, on vÃ©rifie juste qu'elle est dÃ©finie
        log('Test 6 RÃ‰USSI: Fonction transfer_and_delete_franchise prÃ©sente', 'success');

      } catch (error) {
        log('ERREUR GLOBALE: ' + error.message, 'error');
      } finally {
        log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        log('FIN DES TESTS', 'info');
        log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        showSummary();
        document.getElementById('runTests').disabled = false;
      }
    }
  </script>
</body>
</html>
