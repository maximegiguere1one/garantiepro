<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Cr√©ation R√©clamation Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: system-ui;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .result {
            background: #f0fdf4;
            border: 2px solid #10b981;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .error {
            background: #fef2f2;
            border: 2px solid #ef4444;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover { background: #2563eb; }
        pre {
            white-space: pre-wrap;
            font-size: 12px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .customer-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .customer-card {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #3b82f6;
            transition: all 0.2s;
        }
        .customer-card:hover {
            background: #dbeafe;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .warranty-card {
            background: #f0fdf4;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        h1 { color: #0f172a; }
        h2 { color: #475569; margin-top: 30px; }
        h3 { color: #64748b; margin-top: 20px; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Cr√©ation de R√©clamation (Admin)</h1>

        <p><strong>Ce test simule exactement ce que fait NewClaimForm.tsx</strong></p>

        <div>
            <button onclick="testFullFlow()">‚ñ∂Ô∏è Tester le Flow Complet</button>
            <button onclick="loadCustomers()">1Ô∏è‚É£ Charger les Clients</button>
        </div>

        <div id="result"></div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://tlmhmqgqxpgeevfvqesu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsbWhtcWdxeHBnZWV2ZnZxZXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc5NzU4NjUsImV4cCI6MjA0MzU1MTg2NX0.kN1cTBD3-LGJ3ksVrXYGlJe36QvP4P4vj5uUDzX9rIE';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.loadCustomers = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">‚è≥ Chargement des clients...</div>';

            try {
                console.log('[Test] Loading customers...');

                const { data, error } = await supabase
                    .from('customers')
                    .select('id, first_name, last_name, email')
                    .order('first_name', { ascending: true });

                if (error) {
                    console.error('[Test] Error loading customers:', error);
                    throw error;
                }

                console.log('[Test] Loaded customers:', data.length);

                let html = `<div class="result">
                    <h3>‚úÖ ${data.length} Clients Charg√©s</h3>
                    <p>Cliquez sur un client pour charger ses garanties actives</p>
                    <div class="customer-list">`;

                data.forEach(c => {
                    html += `<div class="customer-card" onclick="testWarranties('${c.id}', '${c.first_name} ${c.last_name}')">
                        <div><strong>üë§ ${c.first_name} ${c.last_name}</strong></div>
                        <div style="font-size: 14px; color: #64748b; margin-top: 4px;">üìß ${c.email}</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">ID: ${c.id.substring(0, 8)}...</div>
                    </div>`;
                });

                html += '</div></div>';
                resultDiv.innerHTML = html;
            } catch (err) {
                console.error('[Test] Exception:', err);
                resultDiv.innerHTML = `<div class="error">
                    <h3>‚ùå Erreur</h3>
                    <p>${err.message}</p>
                    <pre>${JSON.stringify(err, null, 2)}</pre>
                </div>`;
            }
        };

        window.testWarranties = async function(customerId, customerName) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">‚è≥ Chargement des garanties pour ' + customerName + '...</div>';

            try {
                console.log('[Test] Loading warranties for customer:', customerId);

                // Exactement la m√™me requ√™te que NewClaimForm.tsx ligne 107-118
                const { data, error } = await supabase
                    .from('warranties')
                    .select(`
                        id,
                        contract_number,
                        status,
                        customer_id,
                        end_date,
                        trailers(make, model, year)
                    `)
                    .eq('customer_id', customerId)
                    .eq('status', 'active')
                    .gte('end_date', new Date().toISOString())
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('[Test] Error loading warranties:', error);
                    throw error;
                }

                console.log('[Test] Loaded warranties:', {
                    customerId,
                    count: data?.length || 0,
                    warranties: data
                });

                let html = `<div class="result">
                    <h2>üìã Garanties pour ${customerName}</h2>
                    <p><span class="badge badge-${data?.length > 0 ? 'success' : 'warning'}">${data?.length || 0} garantie(s) active(s)</span></p>`;

                if (data && data.length > 0) {
                    html += '<div>';
                    data.forEach(w => {
                        const trailer = w.trailers;
                        html += `<div class="warranty-card">
                            <div><strong>üîñ ${w.contract_number}</strong></div>
                            <div style="margin-top: 8px; color: #64748b;">
                                <div>üìÖ Fin: ${new Date(w.end_date).toLocaleDateString('fr-CA')}</div>
                                ${trailer ? `<div>üöõ ${trailer.year} ${trailer.make} ${trailer.model}</div>` : ''}
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += `<div class="error">
                        <p><strong>‚ö†Ô∏è Aucune garantie active trouv√©e pour ce client</strong></p>
                        <p>Raisons possibles:</p>
                        <ul>
                            <li>Aucune garantie n'a √©t√© cr√©√©e pour ce client</li>
                            <li>Toutes les garanties sont expir√©es (end_date < aujourd'hui)</li>
                            <li>Toutes les garanties ont un statut autre que "active"</li>
                        </ul>
                    </div>`;
                }

                html += '<h3>üîç D√©tails de la Requ√™te</h3>';
                html += `<pre>Requ√™te SQL ex√©cut√©e:
SELECT id, contract_number, status, customer_id, end_date, trailers(make, model, year)
FROM warranties
WHERE customer_id = '${customerId}'
  AND status = 'active'
  AND end_date >= '${new Date().toISOString()}'
ORDER BY created_at DESC

R√©sultat: ${data?.length || 0} ligne(s)</pre>`;

                html += '</div>';
                resultDiv.innerHTML = html;
            } catch (err) {
                console.error('[Test] Exception:', err);
                resultDiv.innerHTML = `<div class="error">
                    <h3>‚ùå Erreur</h3>
                    <p>${err.message}</p>
                    <pre>${JSON.stringify(err, null, 2)}</pre>
                </div>`;
            }
        };

        window.testFullFlow = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">‚è≥ Test du flow complet...</div>';

            try {
                // 1. Charger les clients
                console.log('[Test] Step 1: Loading customers...');
                const { data: customers, error: customersError } = await supabase
                    .from('customers')
                    .select('id, first_name, last_name, email')
                    .order('first_name', { ascending: true });

                if (customersError) throw customersError;

                console.log('[Test] ‚úÖ Loaded', customers.length, 'customers');

                // 2. Pour chaque client, charger les garanties
                let html = '<div class="result"><h2>üß™ R√©sultat du Test Complet</h2>';
                html += `<p>‚úÖ ${customers.length} clients charg√©s</p>`;
                html += '<h3>Garanties par client:</h3>';

                let totalWarranties = 0;

                for (const customer of customers) {
                    const { data: warranties, error: warrantyError } = await supabase
                        .from('warranties')
                        .select(`
                            id,
                            contract_number,
                            status,
                            customer_id,
                            end_date,
                            trailers(make, model, year)
                        `)
                        .eq('customer_id', customer.id)
                        .eq('status', 'active')
                        .gte('end_date', new Date().toISOString())
                        .order('created_at', { ascending: false });

                    if (!warrantyError && warranties) {
                        totalWarranties += warranties.length;
                        if (warranties.length > 0) {
                            html += `<div style="margin: 10px 0; padding: 10px; background: #f0fdf4; border-radius: 6px;">
                                <strong>üë§ ${customer.first_name} ${customer.last_name}</strong>
                                <span class="badge badge-success">${warranties.length} garantie(s)</span>
                            </div>`;
                        }
                    }
                }

                html += `<h3>üìä R√©sum√©</h3>
                <ul>
                    <li><strong>Total clients:</strong> ${customers.length}</li>
                    <li><strong>Total garanties actives:</strong> ${totalWarranties}</li>
                    <li><strong>Clients avec garanties:</strong> ${customers.filter(c => totalWarranties > 0).length}</li>
                </ul>`;

                if (totalWarranties === 0) {
                    html += `<div class="error">
                        <p><strong>‚ö†Ô∏è Aucune garantie active trouv√©e!</strong></p>
                        <p>Vous devez cr√©er des garanties actives avant de pouvoir cr√©er des r√©clamations.</p>
                    </div>`;
                } else {
                    html += `<div class="result">
                        <p><strong>‚úÖ Le formulaire de r√©clamation devrait fonctionner!</strong></p>
                    </div>`;
                }

                html += '</div>';
                resultDiv.innerHTML = html;
            } catch (err) {
                console.error('[Test] Exception:', err);
                resultDiv.innerHTML = `<div class="error">
                    <h3>‚ùå Erreur</h3>
                    <p>${err.message}</p>
                    <pre>${JSON.stringify(err, null, 2)}</pre>
                </div>`;
            }
        };
    </script>
</body>
</html>
