<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Garanties</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: system-ui; max-width: 900px; margin: 50px auto; padding: 20px; }
        .result { background: #f0fdf4; border: 2px solid #10b981; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .error { background: #fef2f2; border: 2px solid #ef4444; padding: 20px; border-radius: 8px; }
        button { background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #2563eb; }
        pre { white-space: pre-wrap; font-size: 12px; }
        .customer { background: #eff6ff; padding: 10px; margin: 5px 0; border-radius: 4px; cursor: pointer; }
        .customer:hover { background: #dbeafe; }
    </style>
</head>
<body>
    <h1>üß™ Test Direct des Garanties</h1>
    
    <div>
        <button onclick="loadCustomers()">1. Charger les clients</button>
        <button onclick="testWarrantyForYan()">2. Test pour Yan Contois</button>
    </div>

    <div id="result"></div>

    <script type="module">
        const SUPABASE_URL = 'https://tlmhmqgqxpgeevfvqesu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsbWhtcWdxeHBnZWV2ZnZxZXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc5NzU4NjUsImV4cCI6MjA0MzU1MTg2NX0.kN1cTBD3-LGJ3ksVrXYGlJe36QvP4P4vj5uUDzX9rIE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.loadCustomers = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">‚è≥ Chargement des clients...</div>';

            try {
                const { data, error } = await supabase
                    .from('customers')
                    .select('id, first_name, last_name, email')
                    .order('first_name', { ascending: true });

                if (error) throw error;

                let html = '<div class="result"><h3>‚úÖ Clients charg√©s: ' + data.length + '</h3>';
                data.forEach(c => {
                    html += `<div class="customer" onclick="testWarranties('${c.id}', '${c.first_name} ${c.last_name}')">
                        üìã ${c.first_name} ${c.last_name} (${c.email})
                    </div>`;
                });
                html += '</div>';
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">‚ùå ${err.message}</div>`;
            }
        };

        window.testWarranties = async function(customerId, customerName) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">‚è≥ Chargement des garanties pour ' + customerName + '...</div>';

            try {
                console.log('Loading warranties for customer:', customerId);

                const { data, error } = await supabase
                    .from('warranties')
                    .select(`
                        id,
                        contract_number,
                        status,
                        customer_id,
                        end_date,
                        trailers(make, model, year)
                    `)
                    .eq('customer_id', customerId)
                    .eq('status', 'active')
                    .gte('end_date', new Date().toISOString())
                    .order('created_at', { ascending: false });

                if (error) throw error;

                console.log('Loaded warranties:', data);

                let html = `<div class="result">
                    <h3>‚úÖ Garanties pour ${customerName}</h3>
                    <p><strong>Nombre:</strong> ${data?.length || 0}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>`;
                resultDiv.innerHTML = html;
            } catch (err) {
                console.error('Error:', err);
                resultDiv.innerHTML = `<div class="error">‚ùå ${err.message}<pre>${JSON.stringify(err, null, 2)}</pre></div>`;
            }
        };

        window.testWarrantyForYan = async function() {
            await testWarranties('c5a5a663-f693-443a-bfce-a03dcd81eee0', 'Yan Contois');
        };
    </script>
</body>
</html>
