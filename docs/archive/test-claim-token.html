<!DOCTYPE html>
<html>
<head>
    <title>Test Token Validation</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { color: #333; }
        .result { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üß™ Test de Validation du Token de R√©clamation</h1>
    <div id="result" class="result">‚è≥ Test en cours...</div>

    <script>
        const SUPABASE_URL = 'https://lfpdfdugijzewshxwofy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmcGRmZHVnaWp6ZXdzaHh3b2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Njc3MTIsImV4cCI6MjA3NzE0MzcxMn0.L7AvQrsYzcximQJ2oNyT7K69jIJSWofUnaRwvZkY4a4';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const token = '020f9d7a-aee7-485e-bac4-f4bade5c132d';

        async function testToken() {
            const resultDiv = document.getElementById('result');
            let html = '<h2>R√©sultats du test:</h2>';

            try {
                // Test 1: R√©cup√©rer le token
                html += '<h3>1Ô∏è‚É£ Test de r√©cup√©ration du token</h3>';
                const { data: tokenData, error: tokenError } = await supabase
                    .from('warranty_claim_tokens')
                    .select('*')
                    .eq('token', token)
                    .maybeSingle();

                if (tokenError) {
                    html += `<p class="error">‚ùå Erreur: ${tokenError.message}</p>`;
                    console.error('Token error:', tokenError);
                    resultDiv.innerHTML = html;
                    return;
                }

                if (!tokenData) {
                    html += '<p class="error">‚ùå Token introuvable dans la base de donn√©es</p>';
                    resultDiv.innerHTML = html;
                    return;
                }

                html += `<p class="success">‚úÖ Token trouv√©: ${tokenData.token}</p>`;
                html += `<p>Warranty ID: ${tokenData.warranty_id}</p>`;
                html += `<p>Utilis√©: ${tokenData.is_used ? 'Oui ‚ùå' : 'Non ‚úÖ'}</p>`;
                html += `<p>Expire: ${new Date(tokenData.expires_at).toLocaleString()}</p>`;
                html += `<p>Acc√®s: ${tokenData.access_count} fois</p>`;

                // Test 2: R√©cup√©rer la garantie
                html += '<h3>2Ô∏è‚É£ Test de r√©cup√©ration de la garantie</h3>';
                const { data: warrantyData, error: warrantyError } = await supabase
                    .from('warranties')
                    .select('*, customers(*), trailers(*), warranty_plans(*)')
                    .eq('id', tokenData.warranty_id)
                    .maybeSingle();

                if (warrantyError) {
                    html += `<p class="error">‚ùå Erreur: ${warrantyError.message}</p>`;
                    console.error('Warranty error:', warrantyError);
                    resultDiv.innerHTML = html;
                    return;
                }

                if (!warrantyData) {
                    html += '<p class="error">‚ùå Garantie introuvable</p>';
                    resultDiv.innerHTML = html;
                    return;
                }

                html += `<p class="success">‚úÖ Garantie trouv√©e: ${warrantyData.contract_number}</p>`;
                html += `<p>Client: ${warrantyData.customers?.first_name} ${warrantyData.customers?.last_name}</p>`;
                html += `<p>V√©hicule: ${warrantyData.trailers?.year} ${warrantyData.trailers?.make} ${warrantyData.trailers?.model}</p>`;
                html += `<p>Plan: ${warrantyData.warranty_plans?.name}</p>`;
                html += `<p>D√©but: ${new Date(warrantyData.start_date).toLocaleDateString()}</p>`;
                html += `<p>Fin: ${new Date(warrantyData.end_date).toLocaleDateString()}</p>`;

                html += '<h2 class="success">‚úÖ TOUS LES TESTS R√âUSSIS!</h2>';
                html += '<p>Le syst√®me de r√©clamation fonctionne correctement.</p>';
                html += '<p><strong>Le probl√®me est que l\'application React n\'est pas accessible.</strong></p>';

            } catch (error) {
                html += `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                console.error('Error:', error);
            }

            resultDiv.innerHTML = html;
        }

        testToken();
    </script>
</body>
</html>
